{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ block.super }}Power2U{% endblock %}
    
{% block navbar-left %}
  {% include "_navbar.html" with active_link="home" %}
{% endblock %}

{% block navbar-right %}
  {% if not user.is_authenticated %}
<a class="btn btn-default" href="{% url 'accounts:login' %}" role="button">Log in</a>
<!--<a class="btn btn-primary" href="{% url 'accounts:signup' %}" role="button">Sign up</a> -->
  {% else %}
    {{ block.super }}
  {% endif %}
{% endblock %}

{% block splash %}
<br>
{% endblock splash %}
{% block extrahead %}
    <style>
    .btn {
    	font-size: 10px;
    }
    
    </style>
{% endblock extrahead %}
{% block container %}     
    <div class="container">
		<h1>{% trans "Device List" %}</h1>

	    {% if numrows_remote %}
	    <h3><b>{% trans "REMOTE DEVICES" %}</b></h3>
	    <div id="remotedevicelist" class="table-responsive">
	    <table id="RemoteDevicesTable" class="table table-striped table-bordered table-responsive ">
            <colgroup>
              <col class="col-xs-3"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-2"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-2"></col>
              <col class="col-xs-1"></col>
            </colgroup>
	    	<thead class="thead-inverse">
			    <tr>
			        <th>{% trans "Device name" %}</th>
			        <th>{% trans "Device IP" %}</th>
			        <th>{% trans "Device type" %}</th>
			        <th colspan="2">{% trans "Device state" %}</th>
			        <th>{% trans "Delete device" %}</th>
			        <th>{% trans "Last updated" %}</th>
			        <th>{% trans "Device webpage" %}</th>
			    </tr>
			 </thead>
			 <tbody>
	      {% for device in RemotedeviceList %}
	      	<tr> 
		        <td data-title="{% trans "Device Name" %}">{{ device.DeviceName }}</td>
		        <td data-title="{% trans "Device IP" %}">{{ device.DeviceIP }}</td>
		        <td data-title="{% trans "Device type" %}">{{ device.Type.Code }}</td>
		        {% if device.DeviceState == "STOPPED" %}
		        	<td data-title="Device state" bgcolor= "#FF0000">{{ device.DeviceState }}</td>		        	
		        	<td>
		        	{% if perms.RemoteDevices.change_state %}
		        		<a id="Rtoggle{{ forloop.counter }}" onclick="toggle_Device('{{ device.DeviceName }}','RDevice_update','RemoteDevicesTable')" class="btn btn-default btn-xs" id="" role="button">{% trans "RUN" %} &raquo;</a>
		        	{% else %}
		        	
		        	{% endif %}
		        	</td>
		        	<td>
					{% if perms.RemoteDevices.add_device %}
		        		<a id="Rdelete{{ forloop.counter }}" style="visibility:visible;" onclick="delete_Device('{{ device.DeviceName }}','R')" class="btn btn-default btn-xs" id="" role="button"><span class="glyphicon glyphicon-remove-circle"></span></a>	
		        	{% endif %}
		        	</td>
		        {% elif device.DeviceState == "RUNNING" %} 
		        	{% if device.DeviceHTTPCode == 200 %}
		        	<td data-title="Device state" bgcolor="#00FF00">{{ device.DeviceState }}</td>
		        	{% else %}
		        	<td data-title="Device state" bgcolor="#FACC2E">{{ device.DeviceState }} <b><font color="red">{% trans " Error: " %} {{ device.DeviceHTTPCode }}</font></b></td>
		        	{% endif %}
		        	<td>
					{% if perms.RemoteDevices.change_state %}
		        		<a id="Rtoggle{{ forloop.counter }}" onclick="toggle_Device('{{ device.DeviceName }}','RDevice_update','RemoteDevicesTable')" class="btn btn-default btn-xs" id="" role="button">{% trans "STOP" %} &raquo;</a>		        	
		        	{% endif %}
		        	</td>
		        	<td>
                    {% if perms.RemoteDevices.add_device %}
		        		<a id="Rdelete{{ forloop.counter }}" style="visibility:hidden;" onclick="delete_Device('{{ device.DeviceName }}','R')" class="btn btn-default btn-xs" id="" role="button"><span class="glyphicon glyphicon-remove-circle"></span></a>	
		        	{% endif %}
		        	</td>
		        {% endif %} 
		        	<td data-title="{% trans "Last updated" %}">{{ device.LastUpdated }}</td>
		        	<td>
					{% if perms.Devices.view_plots %}
		        		<a class="btn btn-default btn-xs" href="{% url 'devicepage' device.pk %}" id="" role="button">{% trans "Advanced" %}  &raquo;</a>		        	
		        	{% endif %}
		        	</td>
	    	</tr>
	      {% endfor %}
	      	</tbody>
	    </table>
	    </div>
	    {% else %}
	      <h3>{% trans "There are no registered remote devices in the installation." %}</h3>
	    {% endif %} 
        
        {% if numrows_local %}
	    <h3><b>{% trans "LOCAL DEVICES" %}</b></h3>
	    <div id="localdevicelist" class="table-responsive">
	    <table id="LocalDevicesTable" class="table table-striped table-bordered table-responsive ">
            <colgroup>
              <col class="col-xs-3"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-2"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-1"></col>
              <col class="col-xs-2"></col>
              <col class="col-xs-1"></col>
            </colgroup>
	    	<thead class="thead-inverse">
			    <tr>
			        <th>{% trans "Device name" %}</th>
			        <th>{% trans "Pin" %}</th>
			        <th>{% trans "Device type" %}</th>
			        <th colspan="2">{% trans "Device state" %}</th>
			        <th>{% trans "Delete device" %}</th>
			        <th>{% trans "Last updated" %}</th>
			        <th>{% trans "Device webpage" %}</th>
			    </tr>
			 </thead>
			 <tbody>
	      {% for device in LocaldeviceList %}
	      	<tr> 
		        <td data-title="{% trans "Device Name" %}">{{ device.DeviceName }}</td>
		        <td data-title="{% trans "Device Pin" %}">{{ device.IO.pin }}</td>
		        <td data-title="{% trans "Device type" %}">{{ device.Type.Code }}</td>
		        {% if device.DeviceState == "STOPPED" %}
		        	<td data-title="Device state" bgcolor= "#FF0000">{{ device.DeviceState }}</td>		        	
		        	<td>
		        	{% if perms.LocalDevices.change_state %}
		        		<a id="Ltoggle{{ forloop.counter }}" onclick="toggle_Device('{{ device.DeviceName }}','LDevice_update','LocalDevicesTable')" class="btn btn-default btn-xs" id="" role="button">{% trans "RUN" %} &raquo;</a>
		        	{% else %}
		        	
		        	{% endif %}
		        	</td>
		        	<td>
					{% if perms.LocalDevices.add_device %}
		        		<a id="Ldelete{{ forloop.counter }}" style="visibility:visible;" onclick="delete_Device('{{ device.DeviceName }}','L')" class="btn btn-default btn-xs" id="" role="button"><span class="glyphicon glyphicon-remove-circle"></span></a>	
		        	{% endif %}
		        	</td>
		        {% elif device.DeviceState == "RUNNING" %} 
		        	{% if device.Connected %}
		        	<td data-title="Device state" bgcolor="#00FF00">{{ device.DeviceState }}</td>
		        	{% else %}
		        	<td data-title="Device state" bgcolor="#FACC2E">{{ device.DeviceState }} {% trans " Error " %}</td>
		        	{% endif %}
		        	<td>
					{% if perms.LocalDevices.change_state %}
		        		<a id="Ltoggle{{ forloop.counter }}" onclick="toggle_Device('{{ device.DeviceName }}','LDevice_update','LocalDevicesTable')" class="btn btn-default btn-xs" id="" role="button">{% trans "STOP" %} &raquo;</a>		        	
		        	{% endif %}
		        	</td>
		        	<td>
                    {% if perms.LocalDevices.add_device %}
		        		<a id="Ldelete{{ forloop.counter }}" style="visibility:hidden;" onclick="delete_Device('{{ device.DeviceName }}','L')" class="btn btn-default btn-xs" id="" role="button"><span class="glyphicon glyphicon-remove-circle"></span></a>	
		        	{% endif %}
		        	</td>
		        {% endif %} 
		        	<td data-title="{% trans "Last updated" %}">{{ device.LastUpdated }}</td>
		        	<td>
					{% if perms.Devices.view_plots %}
		        		<a class="btn btn-default btn-xs" href="{% url 'devicepage' device.pk %}" id="" role="button">{% trans "Advanced" %}  &raquo;</a>		        	
		        	{% endif %}
		        	</td>
	    	</tr>
	      {% endfor %}
	      	</tbody>
	    </table>
	    </div>
	    {% else %}
	      <h3>{% trans "There are no registered local devices in the installation." %}</h3>
	    {% endif %} 
        
	    <a class="btn btn-primary" href="{% url 'home' %}"  role="button">{% trans "Return to Main" %} &raquo;</a></p>
    </div><!-- /.container -->
          
{% endblock container %} 

{% block scripts %}
<script>
		var ws_path =  "/stream/DeviceModels/";
		console.log("Connecting to " + ws_path);
		var webSocketBridge = new channels.WebSocketBridge();
		webSocketBridge.connect(ws_path);
		webSocketBridge.listen();
			
        $(function () {
            
            webSocketBridge.demultiplex('RDevice_params', function(payload, streamName) {
                // Handle different actions
                if (payload.action == "create") {
                    // Create the new GPIO model
					add_Device('RemoteDevicesTable','R',payload.data.DeviceName,payload.data.DeviceIP,payload.data.Type,payload.data.DeviceState,payload.data.LastUpdated)
                    console.log("New Device model created : " + payload.data.toString());
                } else if (payload.action == "update") {
					update_Device('RemoteDevicesTable','R',payload.data.DeviceName,payload.data.DeviceIP,payload.data.Type,payload.data.DeviceState,payload.data.LastUpdated)
                    console.log("Device updated : " + payload.data.toString());
                } else if (payload.action == "delete") {
					delete_Row('RemoteDevicesTable',payload.data.DeviceName)
                	console.log("Device deleted : " + payload.data.toString());
                } else {
                    console.log("Unknown action " + payload.action);
                }
            });
            
            webSocketBridge.demultiplex('LDevice_params', function(payload, streamName) {
                // Handle different actions
                if (payload.action == "create") {
                    // Create the new GPIO model
					add_Device('LocalDevicesTable','L',payload.data.DeviceName,payload.pk,payload.data.Type,payload.data.DeviceState,payload.data.LastUpdated)
                    console.log("New Device model created : " + payload.data.toString());
                } else if (payload.action == "update") {
					update_Device('LocalDevicesTable','L',payload.data.DeviceName,payload.pk,payload.data.Type,payload.data.DeviceState,payload.data.LastUpdated)
                    console.log("Device updated : " + payload.data.toString());
                } else if (payload.action == "delete") {
					delete_Row('LocalDevicesTable',payload.data.DeviceName)
                	console.log("Device deleted : " + payload.data.toString());
                } else {
                    console.log("Unknown action " + payload.action);
                }
            });
            
            // Helpful debugging
            webSocketBridge.socket.addEventListener('open', 
                function() { 
                    console.log("Connected to notification socket"); 
                    label=document.getElementById('RT_status');
                    label.style.color="LimeGreen";
                    label.innerHTML="Connected to RT engine"
            });
            webSocketBridge.socket.addEventListener('close', 
                function() { 
                    console.log("Disconnected to notification socket"); 
                    label=document.getElementById('RT_status');
                    label.style.color="Red";
                    label.innerHTML="Disconnected from RT engine"
            });
        });

		function add_Device(tableID,prefix,DeviceName,IPAddr,DeviceType,DeviceState,LastUpdated){
			var table=document.getElementById(tableID);

			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            var cell7 = row.insertCell(6);
            var cell8 = row.insertCell(7);
			cell1.innerHTML=DeviceName;
			row.appendChild(cell1);
			cell2.innerHTML=IPAddr;
			row.appendChild(cell2);
			cell3.innerHTML=DeviceType;
			row.appendChild(cell3);
			cell4.innerHTML=DeviceState;
            var buttonToggle=document.createElement('a');
            buttonToggle.className="btn btn-default btn-xs";
            buttonToggle.role="button";
            buttonToggle.id=prefix+"toggle"+(table.rows.length-1).toString();
            var buttonDel=document.createElement('a');
            buttonDel.className="btn btn-default btn-xs";
            buttonDel.role="button";
            buttonDel.id=prefix+"delete"+(table.rows.length-1).toString();
            var buttonSpan=document.createElement('span');
            buttonSpan.className="glyphicon glyphicon-remove-circle";
            buttonDel.appendChild(buttonSpan);
            if (DeviceState=="STOPPED")
            {
                cell4.style.backgroundColor= "#FF0000";
                buttonToggle.innerHTML='{% trans " Start " %} >>';
                buttonDel.style.visibility='visible';
            }
            else{
                cell4.style.backgroundColor= "#00FF00";
                buttonToggle.innerHTML='{% trans " Stop " %} >>';
                buttonDel.style.visibility='hidden';
            }
            buttonToggle.addEventListener("click", function(){ toggle_Device(DeviceName,prefix + 'Device_update',tableID); });
            cell5.appendChild(buttonToggle);
            buttonDel.addEventListener("click", function(){ delete_Device(DeviceName,prefix); });
            cell6.appendChild(buttonDel);
			row.appendChild(cell4);
            row.appendChild(cell5);
            row.appendChild(cell6);
            cell7.innerHTML="27/11/1981 04:00:00";
            row.appendChild(cell7);
            row.appendChild(cell8);
		}
		
		function toggle_Device(DeviceName,stream,table) {
			var table=document.getElementById(table);
			webSocketBridge.stream(stream).send({
                    "pk": 0,
                    "action": "update",
                    "data": {
                        "DeviceName": DeviceName,
                    }
                });
		}
		
		function update_Device(tableID,prefix,DeviceName,IPAddr,DeviceType,DeviceState,LastUpdated){
			var table=document.getElementById(tableID);
			var rownum=-1;
			for (var i = 0, row; row = table.rows[i]; i++) {
				if ((row.cells[0].innerHTML==DeviceName) || (row.cells[1].innerHTML==IPAddr))
				{
					rownum=i;
					break;
				}
			}
			if (rownum>0)
			{
				var row=table.rows[rownum];
				if (typeof DeviceName != "undefined") {row.cells[0].innerHTML=DeviceName;}
				if (typeof IPAddr != "undefined") {row.cells[1].innerHTML=IPAddr;}
                if (typeof DeviceType != "undefined") {row.cells[2].innerHTML=DeviceType;}
                if (typeof DeviceState != "undefined") {
                    row.cells[3].innerHTML=DeviceState;
                    buttonToggle=document.getElementById(prefix+'toggle'+rownum.toString());
                    buttonDel=document.getElementById(prefix+'delete'+rownum.toString());
                    if (DeviceState=="STOPPED")
                    {
                        row.cells[3].style.backgroundColor= "#FF0000";
                        buttonToggle.innerHTML='{% trans " Start " %} >>';
                        buttonDel.style.visibility='visible';
                    }
                    else{
                        row.cells[3].style.backgroundColor= "#00FF00";
                        buttonToggle.innerHTML='{% trans " Stop " %} >>';
                        buttonDel.style.visibility='hidden';
                    }
                }
                if (typeof LastUpdated != "undefined") {
                    var offset = new Date().getTimezoneOffset();
                    var d = new Date(LastUpdated);
                    row.cells[6].innerHTML=d.toLocaleString();
                }
			}
		}
		
		function delete_Row(tableID,DeviceName) {
			var table=document.getElementById(tableID);
			for (var i = 0, row; row = table.rows[i]; i++) {
				if (row.cells[0].innerHTML==DeviceName)
				{
					table.deleteRow(i);
					break;
				}
			}
            if (table.rows.length==1)
            {
                table.deleteRow(0);
            }
		}
        
        function delete_Device(DeviceName,prefix) {
			webSocketBridge.stream(prefix+'Device_delete').send({
                    "pk": 0,
                    "action": "delete",
                    "data": {
                        "DeviceName": DeviceName,
                    }
                });
		}
    </script>
	
{% endblock scripts %}
	