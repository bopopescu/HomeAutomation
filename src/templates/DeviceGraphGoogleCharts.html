<!-- TODO: try with charts from https://www.rgraph.net/ -->
{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}

{% load staticfiles %}
  {% block extrahead %}
    <style>
    .charts {
    	width: 100%;
    	height: 50%;
    }
    .row-graph{
    	position:relative;
    	top:2em;
    	margin-left: 5px;
    	max-height:100%;
    }
    .col-lg-3{
    	border:1px solid black;
    }
    .btn {
    	font-size: 10px;
    }
    .treeview, .treeview ul {
    margin:0;
    padding:0;
    list-style:none;
    
	color: #369;
	}
	.treeview ul {
	    margin-left:1em;
	    position:relative
	}
	.treeview ul ul {
	    margin-left:.5em
	}
	.treeview ul:before {
	    content:"";
	    display:block;
	    width:0;
	    position:absolute;
	    top:0;
	    left:0;
	    border-left:1px solid;
	    
	    /* creates a more theme-ready standard for the bootstrap themes */
	    bottom:15px;
	}
	.treeview li {
	    margin:0;
	    padding:0 1em;
	    line-height:2em;
	    font-weight:700;
	    position:relative
	}
	.treeview ul li:before {
	    content:"";
	    display:block;
	    width:10px;
	    height:0;
	    border-top:1px solid;
	    margin-top:-1px;
	    position:absolute;
	    top:1em;
	    left:0
	}
	.tree-indicator {
	    margin-right:5px;
	    
	    cursor:pointer;
	}
	.treeview li a {
	    text-decoration: none;
	    color:inherit;
	    
	    cursor:pointer;
	}
	.treeview li button, .treeview li button:active, .treeview li button:focus {
	    text-decoration: none;
	    color:inherit;
	    border:none;
	    background:transparent;
	    margin:0px 0px 0px 0px;
	    padding:0px 0px 0px 0px;
	    outline: 0;
	}
    </style>
    <script type="text/javascript" src="{% static 'site/js/moment-with-locales.min.js'%}" ></script>
    <script type="text/javascript" src="{% static 'site/js/bootstrap-datetimepicker.min.js'%}" charset="UTF-8"></script>
    <link href="{% static 'site/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet">
  {% endblock extrahead %}
  {% block container %}
  <div class="container">
	  <div id="row1" class="row row-graph">
	  {% if devicename %}
	  <h1>{% trans "Graphs for the device " %} {{ devicename }}</h1>
	  {% else %}
	  <h1>{% trans "Graphs from a device" %}</h1>
	  {% endif %}
	  </div>
	  <div id="row2" class="row row-graph">
		 {% crispy Form %}
	  </div>  
	  <div id="base" class="row row-graph" >  	
	  </div>
	</div>
  {% endblock container %}
  
  {% block scripts %}
  	<script type="text/javascript" src="{% static 'googleCharts/loader.js'%}"></script> 
<!--   	"https://www.gstatic.com/charts/loader.js"  -->
    <script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(loadData);
       
	var DBdata=Array(),djangoData;
	var graphic_class="col-sm-8 col-lg-9";
	var statistics_class="col-sm-4 col-lg-3";
    function loadData()
    {
    	try
    	{
	    	djangoData = JSON.parse('{{ chart|safe }}');
	    	var i;
	    	var base=document.getElementById('base');
	    	for (i = 0; i < djangoData.length; i++) 
	    	{  
				var arrayData=djangoData[i].cols.concat(djangoData[i].rows);
		    	var data = new google.visualization.arrayToDataTable(arrayData,false);
				views=createViews(data);
				var subindex='analog';		    	
				if (views.analog_view.pg.length>1)
				{	
					var iDiv = document.createElement('div');
			    	iDiv.id = 'row_chart'.concat(i.toString(),subindex);
			    	iDiv.className = "row row-graph";
					base.appendChild(iDiv);
					
					var iDiv2 = document.createElement('div');
			    	iDiv2.id = 'chart_col'.concat(i.toString(),subindex);
			    	iDiv2.className = graphic_class;
			    	iDiv.appendChild(iDiv2);
			    	
			    	var iDiv3 = document.createElement('div');
			    	iDiv3.id = 'stats_col'.concat(i.toString(),subindex);
			    	iDiv3.className = statistics_class;
			    	iDiv.appendChild(iDiv3);
			    	
			    	drawChart(views.analog_view,djangoData[i].title.concat(' analog values'),'chart_col'.concat(i.toString(),subindex));
			    	var stats= document.getElementById('stats_col'.concat(i.toString(),subindex));
			    	var list = document.createElement('ul');
			    	list.className="treeview";
			    	stats.appendChild(list);
			    	var stats_data=djangoData[i].statistics;
			    	var stats_labels=[];
			    	for(var name in stats_data) {
			    		if ((name!='number') && (name!='num_rows'))
			    		{
			    			stats_labels.push(name);
			    		}
			    	}
			    	var j,k;
			    	var text=''
			    	for (j = 1; j < djangoData[i].cols[0].length; j++) // iterates over the number of columns of the chart
			    	{			
			    		var label=	djangoData[i].cols[0][j].label; // j+1 to avoid the timestamp col	
			    		var variable = document.createElement('li');
			    		var stats_list = document.createElement('ul');
			    		if (!label.includes('_bits'))
			    		{
			    			label=label.replace("_"," [").concat("]");
	    					label=label.replace("percent","%")
							label=label.replace("centdeg","\xB0C")
			    		}
			    		variable.appendChild(document.createTextNode(label));
			    		for (k = 0; k < stats_labels.length; k++) // iterates over the number of statistic fields
				    	{ 
			    			var item = document.createElement('li');
			    			if (!label.includes('_bits'))
			    			{
			    				if (!stats_labels[k].includes('on_') && !stats_labels[k].includes('off_'))
			    				{
			    					text=text.concat(stats_labels[k],' value: ',stats_data[stats_labels[k]][j-1].toFixed(2));
			    					item.appendChild(document.createTextNode(text));
			    					stats_list.appendChild(item);
			    					text='';
			    				}
			    			}
				    	}
			    		variable.appendChild(stats_list);
			    		if (!label.includes('_bits')){
			    			list.appendChild(variable);
			    		}
			    	}
			    	
				}
				
				if (views.digital_view.pg.length>1)
				{
					subindex='digital';	
					var iDiv = document.createElement('div');
			    	iDiv.id = 'row_chart'.concat(i.toString(),subindex);
			    	iDiv.className = "row row-graph";
					base.appendChild(iDiv);
					
					var iDiv2 = document.createElement('div');
			    	iDiv2.id = 'chart_col'.concat(i.toString(),subindex);
			    	iDiv2.className = graphic_class;
			    	iDiv.appendChild(iDiv2);
			    	
			    	var iDiv3 = document.createElement('div');
			    	iDiv3.id = 'stats_col'.concat(i.toString(),subindex);
			    	iDiv3.className = statistics_class;
			    	iDiv.appendChild(iDiv3);
			    	
			    	drawChart(views.digital_view,djangoData[i].title.concat(' digital values'),'chart_col'.concat(i.toString(),subindex));
			    	var stats= document.getElementById('stats_col'.concat(i.toString(),subindex));
			    	var list = document.createElement('ul');
			    	list.className="treeview";
			    	stats.appendChild(list);
			    	var stats_data=djangoData[i].statistics;
			    	var stats_labels=[];
			    	for(var name in stats_data) {
			    		if ((name!='number') && (name!='num_rows'))
			    		{
			    			stats_labels.push(name);
			    		}
			    	}
			    	var j,k;
			    	var text=''
			    	for (j = 1; j < djangoData[i].cols[0].length; j++) // iterates over the number of columns of the chart
			    	{			
			    		var label=	djangoData[i].cols[0][j].label; // j+1 to avoid the timestamp col	
			    		var variable = document.createElement('li');
			    		var stats_list = document.createElement('ul');
			    		if (label.includes('_bits'))
			    		{
			    			label=label.replace("_"," [").concat("]");
	    					label=label.replace("percent","%")
							label=label.replace("centdeg","\xB0C")
			    		}
			    		variable.appendChild(document.createTextNode(label));
			    		for (k = 0; k < stats_labels.length; k++) // iterates over the number of statistic fields
				    	{ 
			    			var item = document.createElement('li');
			    			if (label.includes('[bits]'))
			    			{
			    				if (stats_labels[k].includes('on_') || stats_labels[k].includes('off_'))
			    				{
			    					text=text.concat(stats_labels[k],' value: ',stats_data[stats_labels[k]][j-1]);
			    					item.appendChild(document.createTextNode(text));
			    					stats_list.appendChild(item);
			    					text='';
			    				}
			    			}	
				    	}
			    		variable.appendChild(stats_list);
			    		if (label.includes('[bits]')){
			    			list.appendChild(variable);
			    		}
			    	}			    	
				}	    	
	    	}
	    	convert_treeviews();
    	}
    	catch(err)
    	{}
    }
    
    function resizeData()
    {
   	
    	try
    	{
	    	djangoData = JSON.parse('{{ chart|safe }}');
	    	var i;
	    
	    	for (i = 0; i < djangoData.length; i++) 
	    	{  
				var arrayData=djangoData[i].cols.concat(djangoData[i].rows);
		    	var data = new google.visualization.arrayToDataTable(arrayData,false);
				views=createViews(data);
		    	
				if (views.analog_view.pg.length>1)
				{
			    	drawChart(views.analog_view,djangoData[i].title.concat(' analog values'),'chart_col'.concat(i.toString(),'analog'));		    	
				}
				if (views.digital_view.pg.length>1)
				{
			    	
			    	drawChart(views.digital_view,djangoData[i].title.concat(' digital values'),'chart_col'.concat(i.toString(),'digital'));		    	
				}	    	
	    	}
    	}
    	catch(err)
    	{}
    }
    
	function createViews(DataTable)
	{// Creates the views for analog and digital values separately
		var data_analog = new google.visualization.DataView(DataTable);
		var data_digital = new google.visualization.DataView(DataTable);
		colsdigital=[];
		colsanalog=[];
		for (var i = 1; i < DataTable.pg.length; i++) 
    	{ 
			if (DataTable.pg[i].label.indexOf("bits")>=0)
			{
				colsanalog.push(i);
			}else
			{
				colsdigital.push(i);
			}
			DataTable.pg[i].label=DataTable.pg[i].label.replace("_"," [").concat("]");
			DataTable.pg[i].label=DataTable.pg[i].label.replace("percent","%")
			DataTable.pg[i].label=DataTable.pg[i].label.replace("centdeg","\xB0C")
    	}
		data_analog.hideColumns(colsanalog);
		data_digital.hideColumns(colsdigital);
		return {analog_view:data_analog.toDataTable(),digital_view:data_digital.toDataTable()};
	}
	function drawChart(datatable,title,chartId) 
	{
	    var dateFormatter = new google.visualization.DateFormat({pattern: 'dd/MM\nH:mm:ss'});
	 	dateFormatter.format(datatable, 0); 
	   	
	 	var chartwidth = $('#'.concat(chartId)).width();
	 	
	    var options = {
	     	title: title,
//	     	curveType: 'function',
	     	legend: { position: 'bottom' },	     	
	    	animation:{startup:true,duration: 1000,easing: 'out',},
			hAxis: {format: 'dd/MM\nH:mm:ss'},
			vAxis: {
// 		          title: 'Powers',
		          textStyle: {
		            fontSize: 12,
		            bold: false
		          },
		          titleTextStyle: {
		            fontSize: 14,
		            bold: true
		          }
		        },
		   pointSize: 1,
//		   explorer : {maxZoomOut:2,keepInBounds: true,actions: ['dragToZoom', 'rightClickToReset']}
 		   height:chartwidth,
 		   width:chartwidth,
 		   chartArea: { 
 			   			width: '80%', 
 			   			height: '80%',
              			backgroundColor: 'WhiteSmoke',
              			opacity: '5',
          			}
	   	};
	
	   	var chart = new google.visualization.LineChart(document.getElementById(chartId));
	
	   	chart.draw(datatable, options);
	}
	
	$(function () {
        $('#datetimepicker11').datetimepicker({
            inline: true,
            sideBySide: true,
            format: 'dd/mm/yyyy hh:ii:ss', /*remove this line if you want to use time as well */
            todayBtn:'linked',
            todayHighlight:1,
            fontAwesome:true,
            weekStart:1,
            startView: 1,
            minView:0,
            maxView:3,
            initialDate:'yesterday',
            autoclose:true
        });
        $('#datetimepicker12').datetimepicker({
            inline: true,
            sideBySide: true,
            format: 'dd/mm/yyyy hh:ii:ss', /*remove this line if you want to use time as well */
            todayBtn:'linked',
            todayHighlight:1,
            fontAwesome:true,
            weekStart:1,
            startView: 1,
            minView:0,
            maxView:3,
            autoclose:true
        });
    });
	$(window).resize(function(){
		resizeData();
		});

    $.fn.extend({
		treeview:	function() {
			return this.each(function() {
				// Initialize the top levels;
				var tree = $(this);
				
				tree.addClass('treeview-tree');
				tree.find('li').each(function() {
					var stick = $(this);
				});
				tree.find('li').has("ul").each(function () {
					var branch = $(this); //li with children ul
					
					branch.prepend("<i class='tree-indicator glyphicon glyphicon-chevron-right'></i>");
					branch.addClass('tree-branch');
					branch.on('click', function (e) {
						if (this == e.target) {
							var icon = $(this).children('i:first');
							
							icon.toggleClass("glyphicon-chevron-down glyphicon-chevron-right");
							$(this).children().children().toggle();
						}
					})
					branch.children().children().toggle();
					
					/**
					 *	The following snippet of code enables the treeview to
					 *	function when a button, indicator or anchor is clicked.
					 *
					 *	It also prevents the default function of an anchor and
					 *	a button from firing.
					 */
					branch.children('.tree-indicator, button, a').click(function(e) {
						branch.click();
						
						e.preventDefault();
					});
				});
			});
		}
	});

	/**
	 *	The following snippet of code automatically converst
	 *	any '.treeview' DOM elements into a treeview component.
	 */
	function convert_treeviews() {
		$('.treeview').each(function () {
			var tree = $(this);
			tree.treeview();
		})
	}
    </script>
  {% endblock scripts %}