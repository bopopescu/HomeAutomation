{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}
{% load crispy_forms_tags %}



{% block title %}{{ block.super }}Home{% endblock %}

{% block navbar-left %}
  {% include "_navbar.html" with active_link="downloads" %}
{% endblock %}


{% block splash %}

{% get_current_language as LANGUAGE_CODE %}
<!-- Current language: {{ LANGUAGE_CODE }} -->


{% endblock splash %}

{% block extrahead %}
    <style>
    .container{
    	position:relative;
    	top:2em;
    }
    </style>
{% endblock extrahead %}

{% block container %}
<!-- Benefits of the Django application -->

<div class="container">
		<h1>{% trans "Users tracking" %}</h1>
		<p></p>
        <div class="row">
            <!-- #DF5353  red -->
             <!-- #55BF3B // green -->
            <div class="col-md-4">
            	{% if Users %}
            	<table id="Users_table" class="table table-striped table-bordered table-responsive ">
					<thead class="thead-inverse">
					    <tr>
					        <th>{% trans "Name" %}</th>
					        <th>{% trans "Latitude" %}</th>
					        <th>{% trans "Longitude" %}</th>
					        <th>{% trans "Accuracy" %}</th>
					    </tr>
					 </thead>
					 <tbody>
					 	{% for user in Users %}
					 	<tr> 
					        <td>{{ user.name }}</td>
					        <td>{{ user.profile.Latitude }}</td>
					        <td>{{ user.profile.Longitude }}</td>
					        <td>{{ user.profile.Accuracy }}</td>
				        </tr>
				        {% endfor %}
			        </tbody>
		        </table>
		        {% endif %}
            </div>
             
            <div class="col-md-8" id="content-main">
                
            </div>
        </div>
		<p></p>
	    <a class="btn btn-primary" href="{% url 'advancedDevice' %}"  role="button">{% trans "Return" %} &raquo;</a></p>
</div><!-- /.container -->




{% endblock container %}

{% block scripts %}
<script src="{% static 'site/js/site.js' %}"></script>	
<script src="{% static 'GoogleMapsLatLong.js' %}"></script>	
<script>
  
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
		var ws_path =  "/stream/UserTracking/";
		console.log("Connecting to " + ws_path);
        
		var webSocketBridge = new channels.WebSocketBridge();
		webSocketBridge.connect(ws_path);
		webSocketBridge.listen();

        
        $(function () {
            
        	webSocketBridge.demultiplex('Profiles_values', function(payload, streamName) {
                // Handle different actions
                if (payload.action == "create") {
                    // Create the new GPIO model
                    console.log("New profile created");
                } else if (payload.action == "update") {
					//update_GPIO(payload.pk,payload.data.value,payload.data.label)
					update_profile(payload.name,payload.data.latitude,payload.data.longitude,payload.data.accuracy)
                    console.log("Profile "+ String(payload.name) + " has changed");
                } else if (payload.action == "delete") {
					//delete_GPIO(parseInt(payload.pk))
                	console.log("Profile model deleted");
                } else {
                    console.log("Unknown action " + payload.action);
                }
            });
            // Helpful debugging
            webSocketBridge.socket.addEventListener('open', 
                function() { 
                    console.log("Connected to notification socket"); 
                    label=document.getElementById('RT_status');
                    label.style.color="LimeGreen";
                    label.innerHTML="Connected to RT engine"
                    query();
            });
            webSocketBridge.socket.addEventListener('close', 
                function() { 
                    console.log("Disconnected to notification socket"); 
                    label=document.getElementById('RT_status');
                    label.style.color="Red";
                    label.innerHTML="Disconnected from RT engine"
            });
        });
        
        function update_profile(name,latitude,longitude,accuracy){
			var table=document.getElementById('Users_table');
			var rownum=-1;
			for (var i = 0, row; row = table.rows[i]; i++) {
				if (parseInt(row.cells[0].innerHTML)==name)
				{
					rownum=i;
					break;
				}
			}
			if (rownum>0)
			{
				var row=table.rows[rownum];
				if (typeof latitude != "undefined") {row.cells[1].innerHTML=latitude;}
				if (typeof longitude != "undefined") {row.cells[2].innerHTML=longitude;}
				if (typeof accuracy != "undefined") {row.cells[3].innerHTML=accuracy;}
			}
		}
        
        
    </script>
	
{% endblock scripts %}

